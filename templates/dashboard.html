{% extends "base.html" %}
{% block title %}Dashboard ‚Äì ebay-agent-cockpit{% endblock %}
{% block content %}

<h1 class="mb-4">Willkommen{% if session.get('user_email') %}, {{ session['user_email'] }}{% endif %}</h1>

<div class="row g-4">
  <!-- Suche -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title mb-2">Schnellsuche</h5>
        <p class="text-secondary small mb-3">
          Free: bis zu <strong>3</strong> Suchbegriffe (je Zeile oder durch Komma getrennt).
          Premium: mehr.
        </p>
        <form action="{{ url_for('search_post') }}" method="post" class="d-grid gap-2">
          <textarea
            name="query"
            rows="5"
            class="form-control"
            placeholder="z.B. Akku 18V, Bosch Professional&#10;Makita Baustellenradio&#10;Milwaukee M18 Akku"
          ></textarea>
          <div class="d-flex align-items-center justify-content-between">
            <small class="text-secondary">Tipp: Jede Zeile = 1 Begriff. Komma geht auch.</small>
            <button type="submit" class="btn btn-primary">
              Suchen
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Status/Info -->
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body">
        <h5 class="card-title mb-2">Status</h5>
        <ul class="list-unstyled mb-0">
          <li>üîê Login aktiv</li>
          <li>üß© Stripe vorbereitet</li>
          <li>üóÑÔ∏è DB: {{ 'ok' }}</li>
        </ul>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title mb-2">Plan</h5>
        {% if session.get('user_id') %}
          <p class="mb-2">
            {% set prem = false %}
            {% if prem %} <!-- Platzhalter; echtes Flag kommt aus Server -->
              ‚úÖ Premium aktiv
            {% else %}
              üîì Du nutzt aktuell die kostenlose Version.
            {% endif %}
          </p>
          <a href="{{ url_for('public_pricing') }}" class="btn btn-outline-primary btn-sm">Upgrade ansehen</a>
        {% else %}
          <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">Jetzt einloggen</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<h1 class="mb-4">Dashboard</h1>

<p class="text-secondary">Willkommen im Dashboard. Unten siehst du den Status deiner Jobs.</p>

{% if session.get('user_id') %}
  <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
{% endif %}

<table class="table table-sm align-middle mt-3">
  <thead>
    <tr>
      <th>ID</th>
      <th>Job</th>
      <th>Status</th>
      <th>Letzter Lauf</th>
    </tr>
  </thead>
  <tbody id="jobs-body">
    <tr><td colspan="4" class="text-secondary">Lade Daten‚Ä¶</td></tr>
  </tbody>
</table>

<script>
(async () => {
  try {
    const res = await fetch("/api/get_all_jobs", {credentials: "same-origin"});
    const data = await res.json();
    const body = document.getElementById("jobs-body");
    body.innerHTML = "";
    if (data.ok && Array.isArray(data.jobs) && data.jobs.length) {
      for (const j of data.jobs) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${j.id ?? ""}</td>
          <td>${j.name ?? ""}</td>
          <td>${j.status ?? ""}</td>
          <td>${j.last_run ?? ""}</td>
        `;
        body.appendChild(tr);
      }
    } else {
      body.innerHTML = `<tr><td colspan="4" class="text-secondary">Keine Jobs gefunden.</td></tr>`;
    }
  } catch (e) {
    document.getElementById("jobs-body").innerHTML =
      `<tr><td colspan="4" class="text-danger">Fehler beim Laden der Jobs.</td></tr>`;
  }
})();
</script>

{% endblock %}