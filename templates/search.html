{% extends "base.html" %}
{% block content %}

<div class="container py-4">
  <div class="text-center mb-4">
    <h1 class="h3">Suche</h1>
    <p class="text-muted mb-0">Gib 1–3 Begriffe an, setze optional Filter – fertig.</p>
  </div>

  <!-- Vorlagen-Suchen -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <strong class="me-2">Vorlagen:</strong>
        <span class="text-muted">ein Klick füllt das Formular & startet die Suche</span>
      </div>

      <div class="d-flex flex-wrap gap-2" id="preset-list">
       <span class="text-muted">wird geladen …</span>
      </div>

  <!-- Suchformular -->
  <form id="searchForm" action="{{ url_for('search') }}" method="post" class="card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Begriff 1</label>
          <input type="text" class="form-control" name="q1" placeholder="z. B. iPhone 11" value="{{ request.args.get('q1','') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Begriff 2</label>
          <input type="text" class="form-control" name="q2" placeholder="optional" value="{{ request.args.get('q2','') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Begriff 3</label>
          <input type="text" class="form-control" name="q3" placeholder="optional" value="{{ request.args.get('q3','') }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Preis min</label>
          <input type="number" step="0.01" class="form-control" name="price_min" placeholder="z. B. 50" value="{{ request.args.get('price_min','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Preis max</label>
          <input type="number" step="0.01" class="form-control" name="price_max" placeholder="z. B. 250" value="{{ request.args.get('price_max','') }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Sortierung</label>
          <select class="form-select" name="sort">
            {% set _sort = request.args.get('sort', 'best') %}
            <option value="best" {{ 'selected' if _sort=='best' else '' }}>Beste Treffer</option>
            <option value="price_asc" {{ 'selected' if _sort=='price_asc' else '' }}>Preis ↑</option>
            <option value="price_desc" {{ 'selected' if _sort=='price_desc' else '' }}>Preis ↓</option>
            <option value="newly" {{ 'selected' if _sort=='newly' else '' }}>Neu eingestellt</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Ergebnisse pro Seite</label>
          {% set _pp = request.args.get('per_page', '20') %}
          <select class="form-select" name="per_page">
            <option value="20" {{ 'selected' if _pp=='20' else '' }}>20</option>
            <option value="40" {{ 'selected' if _pp=='40' else '' }}>40</option>
            <option value="60" {{ 'selected' if _pp=='60' else '' }}>60</option>
            <option value="100" {{ 'selected' if _pp=='100' else '' }}>100</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label d-block mb-1">Zustand</label>
          {% set chosen = request.args.getlist('condition') %}
          <div class="d-flex flex-wrap gap-3">
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="condition" value="NEW" {{ 'checked' if 'NEW' in chosen else '' }}>
              <span class="form-check-label">Neu</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="condition" value="USED" {{ 'checked' if 'USED' in chosen else '' }}>
              <span class="form-check-label">Gebraucht</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="condition" value="CERTIFIED_REFURBISHED" {{ 'checked' if 'CERTIFIED_REFURBISHED' in chosen else '' }}>
              <span class="form-check-label">Refurbished (zert.)</span>
            </label>
          </div>
          <div class="form-text">Mehrfachauswahl möglich.</div>
        </div>
      </div>

      <!-- Bestehende Felder... -->

<!-- NEU: Angebotsformat -->
<div class="mb-3">
  <label class="form-label">Angebotsformat</label>
  <select name="listing_type" class="form-select">
    <option value="all">Alle</option>
    <option value="auction">Nur Auktionen</option>
    <option value="buy_it_now">Nur Sofortkauf</option>
    <option value="auction_with_bin">Auktion mit Sofortkauf</option>
  </select>
</div>

<!-- NEU: Standort -->
<div class="row">
  <div class="col-md-6">
    <label class="form-label">Land</label>
    <select name="location_country" class="form-select">
      <option value="DE">Deutschland</option>
      <option value="AT">Österreich</option>
      <option value="CH">Schweiz</option>
      <option value="">Alle Länder</option>
    </select>
  </div>

  <div class="col-md-6">
    <label class="form-label">PLZ (für Umkreissuche)</label>
    <input type="text" name="zip_code" class="form-control" placeholder="z.B. 44139">
  </div>
</div>

<div class="mb-3">
  <label class="form-label">Umkreis</label>
  <select name="max_distance_km" class="form-select">
    <option value="">Egal</option>
    <option value="25">25 km</option>
    <option value="50">50 km</option>
    <option value="100">100 km</option>
    <option value="200">200 km</option>
  </select>
</div>

<!-- NEU: Weitere Filter -->
<div class="mb-3">
  <div class="form-check">
    <input type="checkbox" name="free_shipping" class="form-check-input" id="freeShip">
    <label class="form-check-label" for="freeShip">
      Nur kostenloser Versand
    </label>
  </div>

  <div class="form-check">
    <input type="checkbox" name="returns_accepted" class="form-check-input" id="returns">
    <label class="form-check-label" for="returns">
      Nur mit Rückgaberecht
    </label>
  </div>

  <div class="form-check">
    <input type="checkbox" name="top_rated_only" class="form-check-input" id="topRated">
    <label class="form-check-label" for="topRated">
      Nur Top-bewertete Verkäufer
    </label>
  </div>

  <div class="form-check">
    <input type="checkbox" name="exclude_international" class="form-check-input" id="excludeInt">
    <label class="form-check-label" for="excludeInt">
      Keine internationalen Angebote
    </label>
  </div>
</div>

      <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">🔎 Suchen</button>
        <button type="reset" class="btn btn-outline-secondary" id="btnReset">Zurücksetzen</button>
        <a href="{{ url_for('public_pricing') }}" class="btn btn-outline-success ms-auto">Preise ansehen</a>
      </div>
    </div>
  </form>

  <!-- Teilen: Direktlink zur GET-Suche -->
  <div class="card mt-4">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <strong class="me-2">Teilen:</strong>
        <span class="text-muted">Erzeuge einen Link (GET) zu genau dieser Suche.</span>
      </div>
      <div class="input-group">
        <input type="text" class="form-control" id="shareUrl" readonly value="">
        <button class="btn btn-outline-primary" type="button" id="btnCopy">Link kopieren</button>
      </div>
      <div class="form-text mt-1">Der Link öffnet direkt die Ergebnisse mit allen Filtern.</div>
    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('searchForm');
    const share = document.getElementById('shareUrl');

    // Presets (Auto-Fill + Auto-Submit)
    // === Dynamische Presets aus /static/templates.json ===

// 1) Presets laden
async function loadPresets() {
  try {
    const res = await fetch('/static/templates.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    return Array.isArray(data?.presets) ? data.presets : [];
  } catch (e) {
    console.warn('Konnte Presets nicht laden:', e);
    return [];
  }
}

// 2) Preset anwenden und Suche starten
function applyPreset(p) {
  form.q1.value = (p.q1 || '').trim();
  form.q2.value = (p.q2 || '').trim();
  form.q3.value = (p.q3 || '').trim();

  form.price_min.value = (p.price_min ?? '').toString();
  form.price_max.value = (p.price_max ?? '').toString();

  form.sort.value = (p.sort || 'best');

  form.querySelectorAll('input[name="condition"]').forEach(cb => (cb.checked = false));
  if (p.cond) {
    p.cond.split(',').map(s => s.trim()).filter(Boolean).forEach(val => {
      const el = form.querySelector('input[name="condition"][value="' + val + '"]');
      if (el) el.checked = true;
    });
  }

  updateShareUrl();
  form.submit(); // nur hier absenden
}

// 3) Buttons in #preset-list rendern
function renderChips(presets) {
  const list = document.getElementById('preset-list');
  if (!list) return;

  list.innerHTML = '';
  if (!presets.length) {
    list.innerHTML = '<span class="text-muted">keine Presets gefunden</span>';
    return;
  }

  presets.forEach(p => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-outline-primary btn-sm';
    btn.textContent = p.label || p.id || 'Preset';
    btn.title = [p.q1, p.q2, p.q3].filter(Boolean).join(' • ');
    btn.addEventListener('click', () => applyPreset(p));
    list.appendChild(btn);
  });

  const reset = document.createElement('button');
  reset.type = 'button';
  reset.className = 'btn btn-outline-secondary btn-sm';
  reset.textContent = 'Zurücksetzen';
  reset.addEventListener('click', () => {
    if (typeof form.reset === 'function') form.reset();
    form.querySelectorAll('input[type="text"], input[type="number"]').forEach(inp => (inp.value = ''));
    form.querySelectorAll('input[name="condition"]').forEach(cb => (cb.checked = false));
    updateShareUrl();
  });
  list.appendChild(reset);
}

// 4) Start
loadPresets().then(renderChips);


    // Build GET-URL zu /search (inkl. Mehrfachparametern "condition")
    function updateShareUrl() {
      const params = new URLSearchParams();

      const q1 = (form.q1.value || '').trim();
      const q2 = (form.q2.value || '').trim();
      const q3 = (form.q3.value || '').trim();
      if (q1) params.set('q1', q1);
      if (q2) params.set('q2', q2);
      if (q3) params.set('q3', q3);

      const pmin = (form.price_min.value || '').trim();
      const pmax = (form.price_max.value || '').trim();
      if (pmin) params.set('price_min', pmin);
      if (pmax) params.set('price_max', pmax);

      const sort = (form.sort.value || 'best').trim();
      if (sort && sort !== 'best') params.set('sort', sort);

      const per = (form.per_page.value || '').trim();
      if (per) params.set('per_page', per);

      // Mehrfachwerte
      form.querySelectorAll('input[name="condition"]:checked').forEach(cb => {
        params.append('condition', cb.value);
      });

      const url = '{{ url_for("search") }}' + (params.toString() ? '?' + params.toString() : '');
      if (share) share.value = url;
    }

    // Eingaben beobachten → Share-URL aktuell halten
    form.addEventListener('input', updateShareUrl);
    form.addEventListener('change', updateShareUrl);
    document.getElementById('btnReset').addEventListener('click', () => {
      setTimeout(updateShareUrl, 0);
    });

    // Kopieren
    document.getElementById('btnCopy').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(share.value);
        const old = document.getElementById('btnCopy').textContent;
        document.getElementById('btnCopy').textContent = '✔️ Kopiert';
        setTimeout(() => document.getElementById('btnCopy').textContent = old, 1200);
      } catch (e) {
        // Fallback
        share.select();
        document.execCommand('copy');
      }
    });

    // Erste Initialisierung
    updateShareUrl();
  })();
</script>

{% endblock %}
