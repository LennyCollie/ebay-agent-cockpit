{% extends "base.html" %}
{% block title %}Suche{% endblock %}

{% block content %}
<div class="container my-4">

  {# Flash-Messages oben anzeigen #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="text-center mb-4">
    <h1 class="fw-bold">
      ğŸ” Super-Agent Suche (Test 02.12.- lokal)
    </h1>
    <p class="text-muted mb-0">
      Gib 1â€“3 Begriffe an, setze optionale Filter â€“ unten erscheinen die Treffer.
    </p>
  </div>

  {# Hauptkarte #}
  <div class="card shadow-sm border-0">
    <div class="card-header bg-gradient"
         style="background: linear-gradient(135deg, #0d6efd, #6610f2); color: #fff;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>Vorlagen:</strong>
          <button type="button" class="btn btn-sm btn-light ms-2 me-1"
                  onclick="fillPreset('iphone 12', '100', '900')">
            Allround-Suche
          </button>
          <button type="button" class="btn btn-sm btn-outline-light me-1"
                  onclick="fillPreset('SchnÃ¤ppchen', '0', '100')">
            SchnÃ¤ppchen
          </button>
          <button type="button" class="btn btn-sm btn-outline-light"
                  onclick="fillPreset('wie neu', '', '')">
            Wie neu
          </button>
        </div>
        <button type="button" class="btn btn-sm btn-outline-light"
                onclick="resetSearchForm()">
          ZurÃ¼cksetzen
        </button>
      </div>
    </div>

    <div class="card-body">

      <form method="POST" action="/search" id="search-form">

        {# --- Begriffe --------------------------------------------------- #}
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Begriff 1</label>
            <input type="text" name="q1" class="form-control"
                   placeholder="z.B. iPhone 12"
                   value="{{ request.args.get('q1','') }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Begriff 2</label>
            <input type="text" name="q2" class="form-control"
                   placeholder="optional"
                   value="{{ request.args.get('q2','') }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Begriff 3</label>
            <input type="text" name="q3" class="form-control"
                   placeholder="optional"
                   value="{{ request.args.get('q3','') }}">
          </div>
        </div>

        {# --- Preis / Sortierung / Anzahl -------------------------------- #}
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label class="form-label">Preis min</label>
            <div class="input-group">
              <input type="number" min="0" step="1" name="price_min" class="form-control"
                     value="{{ request.args.get('price_min','') }}">
              <span class="input-group-text">â‚¬</span>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Preis max</label>
            <div class="input-group">
              <input type="number" min="0" step="1" name="price_max" class="form-control"
                     value="{{ request.args.get('price_max','') }}">
              <span class="input-group-text">â‚¬</span>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Sortierung</label>
            <select name="sort" class="form-select">
              {% set current_sort = request.args.get('sort','best') %}
              <option value="best"       {{ 'selected' if current_sort == 'best' else '' }}>Beste Treffer</option>
              <option value="price_asc"  {{ 'selected' if current_sort == 'price_asc' else '' }}>Preis aufsteigend</option>
              <option value="price_desc" {{ 'selected' if current_sort == 'price_desc' else '' }}>Preis absteigend</option>
              <option value="newly"      {{ 'selected' if current_sort == 'newly' else '' }}>Neu eingestellt</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Ergebnisse pro Seite</label>
            <select name="per_page" class="form-select">
              {% set per_page = request.args.get('per_page','20') %}
              {% for n in [10, 16, 20, 32, 48] %}
                <option value="{{ n }}" {{ 'selected' if per_page == n|string else '' }}>{{ n }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <hr>

        {# --- eBay Filter: Zustand / Versand / Land ----------------------- #}
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label d-block">Zustand</label>
            {% set conds = request.args.getlist('condition') %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cond_new"
                     name="condition" value="NEW"
                     {% if 'NEW' in conds %}checked{% endif %}>
              <label class="form-check-label" for="cond_new">Neu</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cond_used"
                     name="condition" value="USED"
                     {% if 'USED' in conds %}checked{% endif %}>
              <label class="form-check-label" for="cond_used">Gebraucht</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cond_refurb"
                     name="condition" value="CERTIFIED_REFURBISHED"
                     {% if 'CERTIFIED_REFURBISHED' in conds %}checked{% endif %}>
              <label class="form-check-label" for="cond_refurb">Refurbished (zert.)</label>
            </div>
            <small class="text-muted">Mehrfachauswahl mÃ¶glich.</small>
          </div>

          <div class="col-md-4">
            <label class="form-label d-block">Versand & VerkÃ¤ufer</label>
            {% set fs = request.args.get('free_shipping','') %}
            {% set ra = request.args.get('returns_accepted','') %}
            {% set tr = request.args.get('top_rated_only','') %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="fs_only"
                     name="free_shipping" value="1"
                     {% if fs %}checked{% endif %}>
              <label class="form-check-label" for="fs_only">Nur kostenloser Versand</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="ra_only"
                     name="returns_accepted" value="1"
                     {% if ra %}checked{% endif %}>
              <label class="form-check-label" for="ra_only">Nur mit RÃ¼ckgaberecht</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="tr_only"
                     name="top_rated_only" value="1"
                     {% if tr %}checked{% endif %}>
              <label class="form-check-label" for="tr_only">Nur Top-bewertete VerkÃ¤ufer</label>
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Land</label>
            {% set lc = request.args.get('location_country','DE') %}
            <select name="location_country" class="form-select mb-2">
              <option value="DE" {{ 'selected' if lc == 'DE' else '' }}>ğŸ‡©ğŸ‡ª Deutschland</option>
              <option value="AT" {{ 'selected' if lc == 'AT' else '' }}>ğŸ‡¦ğŸ‡¹ Ã–sterreich</option>
              <option value="CH" {{ 'selected' if lc == 'CH' else '' }}>ğŸ‡¨ğŸ‡­ Schweiz</option>
              <option value="EU" {{ 'selected' if lc == 'EU' else '' }}>ğŸ‡ªğŸ‡º EU-weit</option>
              <option value="GB" {{ 'selected' if lc == 'GB' else '' }}>ğŸ‡¬ğŸ‡§ GroÃŸbritannien</option>
              <option value="US" {{ 'selected' if lc == 'US' else '' }}>ğŸ‡ºğŸ‡¸ USA</option>
            </select>

            <label class="form-label mt-2 d-block">Angebotsart</label>
            {% set lt = request.args.get('listing_type','all') %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="listing_type" id="lt_all"
                     value="all" {% if lt == 'all' %}checked{% endif %}>
              <label class="form-check-label" for="lt_all">Alle</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="listing_type" id="lt_fix"
                     value="buy_it_now" {% if lt == 'buy_it_now' %}checked{% endif %}>
              <label class="form-check-label" for="lt_fix">Sofort-Kaufen</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="listing_type" id="lt_auc"
                     value="auction" {% if lt == 'auction' %}checked{% endif %}>
              <label class="form-check-label" for="lt_auc">Auktion</label>
            </div>
          </div>
        </div>

        <hr>

        {# --- Quelle: eBay / Kleinanzeigen / Beides ---------------------- #}
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label d-block">Quelle</label>
            {% set src = request.args.get('source','ebay') %}
            <div class="btn-group" role="group" aria-label="Quelle wÃ¤hlen">
              <input type="radio" class="btn-check" name="source" id="src_ebay"
                     value="ebay" autocomplete="off"
                     {% if src == 'ebay' %}checked{% endif %}>
              <label class="btn btn-outline-primary" for="src_ebay">Nur eBay</label>

              <input type="radio" class="btn-check" name="source" id="src_ka"
                     value="kleinanzeigen" autocomplete="off"
                     {% if src == 'kleinanzeigen' %}checked{% endif %}>
              <label class="btn btn-outline-primary" for="src_ka">Nur Kleinanzeigen</label>

              <input type="radio" class="btn-check" name="source" id="src_both"
                     value="both" autocomplete="off"
                     {% if src == 'both' %}checked{% endif %}>
              <label class="btn btn-outline-primary" for="src_both">Beides (Agent)</label>
            </div>
            <small class="text-muted d-block mt-1">
              Hinweis: In der aktuellen Version werden Kleinanzeigen vor allem
              in den Hintergrund-Alerts genutzt.
            </small>
          </div>

          <div class="col-md-6 text-md-end text-center mt-3 mt-md-0">
            <button type="submit" class="btn btn-primary btn-lg">
              Ergebnisse anzeigen
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
  function fillPreset(term, minPrice, maxPrice) {
    const f = document.getElementById('search-form');
    if (!f) return;
    if (term !== undefined) {
      f.q1.value = term;
      if (f.q2) f.q2.value = '';
      if (f.q3) f.q3.value = '';
    }
    if (minPrice !== undefined) f.price_min.value = minPrice;
    if (maxPrice !== undefined) f.price_max.value = maxPrice;
    // gleich absenden:
    f.submit();
  }

  function resetSearchForm() {
    const f = document.getElementById('search-form');
    if (!f) return;
    f.reset();
    // URL ohne Query-Parameter neu laden
    window.location.href = '/search';
  }
</script>
{% endblock %}
