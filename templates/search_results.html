{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h1 class="h4 mb-0">
    Suchergebnisse
    {% if terms and terms|length > 0 %}
      <small class="text-muted">f√ºr {{ terms|join(" ¬∑ ") }}</small>
    {% endif %}
  </h1>

  {# Teilbarer Link zur aktuellen Suche #}
  <div class="d-flex align-items-center gap-2">
    <input
      id="share-url"
      class="form-control form-control-sm"
      style="min-width: 260px"
      readonly
      value="{{ (request.base_url ~ '?' ~ qs(base_qs)) if base_qs else request.base_url }}"
    >
    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="
      const el=document.getElementById('share-url');
      el.select(); el.setSelectionRange(0,99999);
      document.execCommand('copy');
      this.innerText='Kopiert!';
      setTimeout(()=>this.innerText='Link kopieren',1200);
    ">Link kopieren</button>
  </div>
</div>

{# --- Alerts Toolbar (üîî speichern / ‚úâÔ∏è Testmail) --- #}
<div class="d-flex flex-wrap align-items-center gap-2 mb-4">
  <!-- üîî Alarm speichern -->
  <form action="{{ url_for('alerts_subscribe') }}" method="post" class="d-flex align-items-center gap-2">
    <input type="hidden" name="q1" value="{{ base_qs.get('q1','') }}">
    <input type="hidden" name="q2" value="{{ base_qs.get('q2','') }}">
    <input type="hidden" name="q3" value="{{ base_qs.get('q3','') }}">
    <input type="hidden" name="price_min" value="{{ base_qs.get('price_min','') }}">
    <input type="hidden" name="price_max" value="{{ base_qs.get('price_max','') }}">
    <input type="hidden" name="sort"      value="{{ base_qs.get('sort','best') }}">
    <input type="hidden" name="per_page"  value="{{ base_qs.get('per_page', 20) }}">
    {% for c in (base_qs.get('condition') or []) %}
      <input type="hidden" name="condition" value="{{ c }}">
    {% endfor %}
    <button type="submit" class="btn btn-outline-primary">
      üîî Alarm speichern
    </button>
  </form>

  <!-- ‚úâÔ∏è Jetzt E-Mail testen -->
  <form action="{{ url_for('alerts_send_now') }}" method="post" class="d-flex flex-wrap align-items-center gap-2">
    <input type="hidden" name="q1" value="{{ base_qs.get('q1','') }}">
    <input type="hidden" name="q2" value="{{ base_qs.get('q2','') }}">
    <input type="hidden" name="q3" value="{{ base_qs.get('q3','') }}">
    <input type="hidden" name="price_min" value="{{ base_qs.get('price_min','') }}">
    <input type="hidden" name="price_max" value="{{ base_qs.get('price_max','') }}">
    <input type="hidden" name="sort"      value="{{ base_qs.get('sort','best') }}">
    <input type="hidden" name="per_page"  value="{{ base_qs.get('per_page', 20) }}">
    {% for c in (base_qs.get('condition') or []) %}
      <input type="hidden" name="condition" value="{{ c }}">
    {% endfor %}

    {% set _email = session.get('user_email') or 'guest' %}
    {% if _email == 'guest' %}
      <input type="email" name="email" class="form-control form-control-sm"
             placeholder="E-Mail f√ºr Benachrichtigung" required>
    {% endif %}

    <button type="submit" class="btn btn-success">
      ‚úâÔ∏è Jetzt E-Mail testen
    </button>
  </form>
</div>

{# --- Filter-Zeile / Meta --- #}
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
  <div class="text-muted small">
    {% if pagination.total_estimated %}
      ~{{ pagination.total_estimated }} Treffer gesch√§tzt
      {% if pagination.total_pages %} ¬∑ Seite {{ pagination.page }} von {{ pagination.total_pages }}{% endif %}
    {% else %}
      Seite {{ pagination.page }}
    {% endif %}
  </div>
  <div class="small">
    {% if filters.price_min or filters.price_max or (filters.conditions and filters.conditions|length) or filters.sort != 'best' %}
      <span class="badge text-bg-light">Filter aktiv</span>
      {% if filters.price_min %}<span class="badge text-bg-secondary">ab {{ filters.price_min }}</span>{% endif %}
      {% if filters.price_max %}<span class="badge text-bg-secondary">bis {{ filters.price_max }}</span>{% endif %}
      {% if filters.sort and filters.sort != 'best' %}
        <span class="badge text-bg-secondary">Sort: {{ filters.sort }}</span>
      {% endif %}
      {% for c in (filters.conditions or []) %}
        <span class="badge text-bg-secondary">{{ c }}</span>
      {% endfor %}
    {% endif %}
  </div>
</div>

{# --- Ergebnisse --- #}
{% if results and results|length %}
  <div class="row g-3">
    {% for item in results %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="row g-0 h-100">
            <div class="col-4 d-flex align-items-center justify-content-center p-2">
              {% set img = item.img or 'https://via.placeholder.com/160x120?text=%20' %}
              <img src="{{ img }}" class="img-fluid rounded" alt="Bild" loading="lazy" style="max-height:120px;">
            </div>
            <div class="col-8">
              <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-center gap-1 mb-1">
                  {% set src = (item.src or '')|lower %}
                  {% if src == 'amazon' %}
                    <span class="badge rounded-pill text-bg-warning text-dark">Amazon</span>
                  {% elif src == 'ebay' %}
                    <span class="badge rounded-pill text-bg-primary">eBay</span>
                  {% elif src == 'demo' %}
                    <span class="badge rounded-pill text-bg-secondary">Demo</span>
                  {% endif %}
                  {% if item.term %}
                    <span class="badge text-bg-light">{{ item.term }}</span>
                  {% endif %}
                </div>

                <h2 class="h6 card-title mb-1 text-truncate" title="{{ item.title }}">{{ item.title }}</h2>
                <div class="mb-2 fw-semibold">
                  {{ item.price or '‚Äì' }}
                </div>

                <div class="mt-auto">
                  <a href="{{ item.url }}" target="_blank" rel="nofollow noopener"
                     class="btn btn-sm btn-outline-dark w-100">
                    Zum Angebot √∂ffnen
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info mt-3">
    Keine Treffer gefunden. Bitte Begriffe oder Filter anpassen.
  </div>
{% endif %}

{# --- Pagination --- #}
{% if pagination %}
  <nav class="mt-4" aria-label="Seiten">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a class="page-link"
           href="{% if pagination.has_prev %}{{ url_for('search') }}?{{ qs(base_qs, page=pagination.page-1) }}{% else %}#{% endif %}">
          ‚Äπ Zur√ºck
        </a>
      </li>

      <li class="page-item active">
        <span class="page-link">{{ pagination.page }}</span>
      </li>

      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a class="page-link"
           href="{% if pagination.has_next %}{{ url_for('search') }}?{{ qs(base_qs, page=pagination.page+1) }}{% else %}#{% endif %}">
          Weiter ‚Ä∫
        </a>
      </li>
    </ul>
  </nav>
{% endif %}

{% endblock %}
