{% extends "base.html" %}
{% block content %}

<div class="container py-4">
  <div class="text-center mb-4">
    <h1 class="h3">Suche</h1>
    <p class="text-muted mb-0">Gib 1–3 Begriffe an, setze optional Filter – fertig.</p>
  </div>

  <!-- Vorlagen-Suchen -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <strong class="me-2">Vorlagen:</strong>
        <span class="text-muted">ein Klick füllt das Formular & startet die Suche</span>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <!-- Vorlage 1 -->
        <button type="button"
                class="btn btn-outline-primary btn-sm preset"
                data-q1="iPhone 11"
                data-q2="128GB"
                data-q3=""
                data-price-min=""
                data-price-max="220"
                data-sort="newly"
                data-cond="USED">
          📱 iPhone 11 • 128GB • bis 220€ • gebraucht
        </button>

        <!-- Vorlage 2 -->
        <button type="button"
                class="btn btn-outline-primary btn-sm preset"
                data-q1="LEGO Technic"
                data-q2="42115"
                data-q3=""
                data-price-min="150"
                data-price-max="300"
                data-sort="price_asc"
                data-cond="NEW">
          🧱 LEGO 42115 • 150–300€ • neu
        </button>

        <!-- Vorlage 3 -->
        <button type="button"
                class="btn btn-outline-primary btn-sm preset"
                data-q1="Nintendo Switch OLED"
                data-q2="Zelda"
                data-q3=""
                data-price-min=""
                data-price-max=""
                data-sort="best"
                data-cond="USED,CERTIFIED_REFURBISHED">
          🎮 Switch OLED + Zelda • gebraucht/refurb
        </button>
      </div>
    </div>
  </div>

  <!-- Suchformular -->
  <form id="searchForm" action="{{ url_for('search') }}" method="post" class="card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Begriff 1</label>
          <input type="text" class="form-control" name="q1" placeholder="z. B. iPhone 11" value="{{ request.args.get('q1','') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Begriff 2</label>
          <input type="text" class="form-control" name="q2" placeholder="optional" value="{{ request.args.get('q2','') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Begriff 3</label>
          <input type="text" class="form-control" name="q3" placeholder="optional" value="{{ request.args.get('q3','') }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Preis min</label>
          <input type="number" step="0.01" class="form-control" name="price_min" placeholder="z. B. 50" value="{{ request.args.get('price_min','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Preis max</label>
          <input type="number" step="0.01" class="form-control" name="price_max" placeholder="z. B. 250" value="{{ request.args.get('price_max','') }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Sortierung</label>
          <select class="form-select" name="sort">
            {% set _sort = request.args.get('sort', 'best') %}
            <option value="best" {{ 'selected' if _sort=='best' else '' }}>Beste Treffer</option>
            <option value="price_asc" {{ 'selected' if _sort=='price_asc' else '' }}>Preis ↑</option>
            <option value="price_desc" {{ 'selected' if _sort=='price_desc' else '' }}>Preis ↓</option>
            <option value="newly" {{ 'selected' if _sort=='newly' else '' }}>Neu eingestellt</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Ergebnisse pro Seite</label>
          {% set _pp = request.args.get('per_page', '20') %}
          <select class="form-select" name="per_page">
            <option value="20" {{ 'selected' if _pp=='20' else '' }}>20</option>
            <option value="40" {{ 'selected' if _pp=='40' else '' }}>40</option>
            <option value="60" {{ 'selected' if _pp=='60' else '' }}>60</option>
            <option value="100" {{ 'selected' if _pp=='100' else '' }}>100</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label d-block mb-1">Zustand</label>
          {% set chosen = request.args.getlist('condition') %}
          <div class="d-flex flex-wrap gap-3">
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="condition" value="NEW" {{ 'checked' if 'NEW' in chosen else '' }}>
              <span class="form-check-label">Neu</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="condition" value="USED" {{ 'checked' if 'USED' in chosen else '' }}>
              <span class="form-check-label">Gebraucht</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="condition" value="CERTIFIED_REFURBISHED" {{ 'checked' if 'CERTIFIED_REFURBISHED' in chosen else '' }}>
              <span class="form-check-label">Refurbished (zert.)</span>
            </label>
          </div>
          <div class="form-text">Mehrfachauswahl möglich.</div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-primary">🔎 Suchen</button>
        <button type="reset" class="btn btn-outline-secondary" id="btnReset">Zurücksetzen</button>
        <a href="{{ url_for('public_pricing') }}" class="btn btn-outline-success ms-auto">Preise ansehen</a>
      </div>
    </div>
  </form>

  <!-- Teilen: Direktlink zur GET-Suche -->
  <div class="card mt-4">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <strong class="me-2">Teilen:</strong>
        <span class="text-muted">Erzeuge einen Link (GET) zu genau dieser Suche.</span>
      </div>
      <div class="input-group">
        <input type="text" class="form-control" id="shareUrl" readonly value="">
        <button class="btn btn-outline-primary" type="button" id="btnCopy">Link kopieren</button>
      </div>
      <div class="form-text mt-1">Der Link öffnet direkt die Ergebnisse mit allen Filtern.</div>
    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.getElementById('searchForm');
    const share = document.getElementById('shareUrl');

    // Presets (Auto-Fill + Auto-Submit)
    document.querySelectorAll('.preset').forEach(btn => {
      btn.addEventListener('click', () => {
        // Textfelder
        form.q1.value = btn.dataset.q1 || '';
        form.q2.value = btn.dataset.q2 || '';
        form.q3.value = btn.dataset.q3 || '';

        // Preise
        form.price_min.value = btn.dataset.priceMin || '';
        form.price_max.value = btn.dataset.priceMax || '';

        // Sortierung
        form.sort.value = btn.dataset.sort || 'best';

        // Zustände (erst alles abwählen)
        form.querySelectorAll('input[name="condition"]').forEach(cb => cb.checked = false);
        const cond = (btn.dataset.cond || '').split(',').map(s => s.trim()).filter(Boolean);
        if (cond.length) {
          cond.forEach(val => {
            const el = form.querySelector('input[name="condition"][value="' + val + '"]');
            if (el) el.checked = true;
          });
        }

        // Teilen-URL aktualisieren und absenden
        updateShareUrl();
        form.submit();
      });
    });

    // Build GET-URL zu /search (inkl. Mehrfachparametern "condition")
    function updateShareUrl() {
      const params = new URLSearchParams();

      const q1 = (form.q1.value || '').trim();
      const q2 = (form.q2.value || '').trim();
      const q3 = (form.q3.value || '').trim();
      if (q1) params.set('q1', q1);
      if (q2) params.set('q2', q2);
      if (q3) params.set('q3', q3);

      const pmin = (form.price_min.value || '').trim();
      const pmax = (form.price_max.value || '').trim();
      if (pmin) params.set('price_min', pmin);
      if (pmax) params.set('price_max', pmax);

      const sort = (form.sort.value || 'best').trim();
      if (sort && sort !== 'best') params.set('sort', sort);

      const per = (form.per_page.value || '').trim();
      if (per) params.set('per_page', per);

      // Mehrfachwerte
      form.querySelectorAll('input[name="condition"]:checked').forEach(cb => {
        params.append('condition', cb.value);
      });

      const url = '{{ url_for("search") }}' + (params.toString() ? '?' + params.toString() : '');
      if (share) share.value = url;
    }

    // Eingaben beobachten → Share-URL aktuell halten
    form.addEventListener('input', updateShareUrl);
    form.addEventListener('change', updateShareUrl);
    document.getElementById('btnReset').addEventListener('click', () => {
      setTimeout(updateShareUrl, 0);
    });

    // Kopieren
    document.getElementById('btnCopy').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(share.value);
        const old = document.getElementById('btnCopy').textContent;
        document.getElementById('btnCopy').textContent = '✔️ Kopiert';
        setTimeout(() => document.getElementById('btnCopy').textContent = old, 1200);
      } catch (e) {
        // Fallback
        share.select();
        document.execCommand('copy');
      }
    });

    // Erste Initialisierung
    updateShareUrl();
  })();
</script>

{% endblock %}
